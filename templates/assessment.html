<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>買取査定</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/assenssment.css') }}">
    <script>
        // Wait until DOM is ready before querying elements.
        document.addEventListener('DOMContentLoaded', () => {
            const condition_p = document.getElementById('condition');
            const vegetable_p = document.getElementById('vegetable');
            const reason_p = document.getElementById('reason');
            const price_p = document.getElementById('price');

            const onChangeInputFile = async (e) => {
                const file = e.target.files[0];
                if (e.target.files && file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('thumbnail').setAttribute('src', e.target.result);
                    };
                    reader.readAsDataURL(file);

                    const formData = new FormData();
                    formData.append('vege_image', file);
                    try {
                        const response1 = await fetch('/upload', {
                            method: 'POST',
                            body: formData,
                        });
                        const result1 = await response1.json();
                        const response2 = await fetch(`/assessment/${result1.filename}`, {
                            method: 'POST'
                        });
                        const result2 = await response2.json();
                        vegetable_p.textContent = `種類: ${result2.vegetable}`;
                        condition_p.textContent = `状態: ${result2.condition}`;
                        reason_p.textContent = `理由: ${result2.reason}`;
                        price_p.textContent = `値段: ${result2.price}`;
                    } catch (error) {
                        console.log('アップロードに失敗しました。', error);
                    }
                }
            };

            // expose handler to global so inline onchange="onChangeInputFile(event)" works
            window.onChangeInputFile = onChangeInputFile;
        });
    </script>
</head>
<body>
    <h1>ベジブルアプリ</h1>
    
    <h2>買取査定</h2>
    <div>
        <img id="thumbnail" accept="image/*" src="{{ url_for('static', filename='img/add_pic.png') }}">
    </div>
    <p id="vegetable"></p>
    <p id="condition"></p>
    <p id="reason"></p>
    <p id="price"></p>
    <input type="file" name="vege_image" accept="image/*" onchange="onChangeInputFile(event)">

    <div class="footer">
    <a href="/">査定</a>
    <a href="/message">メッセージ</a>
    <a href="/news">お知らせ</a>
    <a href="/mypage">プロフィール</a>
    </div>
</body>
</html>